version: '3.7'

networks:
  default:

volumes:
  tmp_volume:
  rechat-external-mongodb-data:
    external: true
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/d/MongoDB_WSL/

services:
  beanstalkd:
    image: bodsch/docker-beanstalkd
    container_name: rechat_beanstalkd
    networks:
      - default
    ports:
      - 11300:11300

  php_tools_worker: &php_tools_worker
    build:
      context: ../
      target: app
      dockerfile: ./docker/debug/Dockerfile_php_tools_worker
    restart: always
    container_name: rechat_php_tools_worker
    networks:
      - default
    volumes:
      - &app-data ../:/app
      - &tmp tmp_volume:/tmp
    environment:
      WORKER_NAME: tools
      PHP_IDE_CONFIG: serverName=docker-rechat-php-workers
      REMOTE_HOST: 172.29.128.1
    depends_on:
      - mongo

  php_rechat_worker:
    <<: *php_tools_worker
    restart: always
    container_name: rechat_php_rechat_worker
    volumes:
      - *app-data
      - *tmp
    environment:
      WORKER_NAME: rechat
    depends_on:
      - mongo

  node_discord_worker: &node_discord_worker
    build:
      context: ../
      target: app
      dockerfile: ./docker/debug/Dockerfile_node_bot
    restart: always
    container_name: node_discord_worker
    networks:
      - default
    volumes:
      - *app-data
      - *tmp
    environment:
      WORKER_NAME: worker
    depends_on:
      - mongo

  node_discord_bot:
    <<: *node_discord_worker
    restart: always
    container_name: node_discord_bot
    volumes:
      - *app-data
      - *tmp
    environment:
      WORKER_NAME: bot
    depends_on:
      - mongo

  mongo:
    image: mongo
    networks:
      - default
    restart: always
    container_name: rechat_mongodb
    volumes:
      - rechat-external-mongodb-data:/mnt/d/MongoDB_WSL/data
    ports:
      - 27017:27017
